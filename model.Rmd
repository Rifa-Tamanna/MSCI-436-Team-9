---
title: "model"
output: html_document
date: "2024-07-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages

```{r load packages}
library(dplyr)   
library(readr)  
library(ggplot2)
# library(statsr)
library(gridExtra)
library(corrplot)
library(tidyr)
```

## Moviesets

```{r moviesets}

movieset1 <- read.csv("box office 2.csv")
movieset2 <- read.csv("imdb 2.csv")
movieset3 <- read.csv("metadata.csv")

```

```{r clean dataframe}
# Find duplicate movie titles in each dataset
duplicates_in_movieset1 <- movieset1 %>% filter(duplicated(movie_title) | duplicated(movie_title, fromLast = TRUE))
duplicates_in_movieset2 <- movieset2 %>% filter(duplicated(movie_title) | duplicated(movie_title, fromLast = TRUE))
duplicates_in_movieset3 <- movieset3 %>% filter(duplicated(movie_title) | duplicated(movie_title, fromLast = TRUE))

# print(duplicates_in_movieset1)
# print(duplicates_in_movieset2)
# print(duplicates_in_movieset3)

# Remove duplicate rows based on movie_title
movieset1 <- movieset1 %>% distinct(movie_title, .keep_all = TRUE)
movieset2 <- movieset2 %>% distinct(movie_title, .keep_all = TRUE)
movieset3 <- movieset3 %>% distinct(movie_title, .keep_all = TRUE)

merged_df <- movieset1 %>%
  full_join(movieset2, by = "movie_title") %>%
  full_join(movieset3, by = "movie_title")

# print(merged_df)

# Select columns to keep
cleaned_df <- merged_df %>% select(movie_title, gross, content_rating, genres, plot_keywords, director_name, actor_1_name, actor_2_name, actor_3_name, language, country, budget, title_year)

# Print the cleaned data frame
# print(cleaned_df)

# Filter out rows with NA in any column
filtered_df <- cleaned_df %>% filter(complete.cases(.))

cleaned_genres_df <- filtered_df %>%
  separate(genres, into = paste0("genre_", 1:5), sep = "\\|", fill = "right")

# Print the resulting dataset
print(cleaned_genres_df)

# Number of bins
num_bins <- 4

bin_labels <- c("Low", "Medium", "High", "Very High")

# Cut the data into equal width bins with labels
# cleaned_genres_df$gross_equal_width_bins <- cut(cleaned_genres_df$gross, breaks = num_bins, labels = bin_labels)

# Print the result
# print(cleaned_genres_df)

# genre_list <- strsplit(filtered_df$genres, "\\|")[[1]]
# print(genre_list)
# 
# genre_dummy <- as.data.frame(table(genre_factors))

# Print the filtered data frame
# print(filtered_df)

```
```{r  numerical variables}
summary(filtered_df)

hist(filtered_df$gross, breaks = 30)
summary(filtered_df$gross)

p1 <- ggplot(aes(x=log10(filtered_df$budget)), data=filtered_df) + 
  geom_histogram(aes(y=100*(..count..)/sum(..count..)), color='black', fill='white') + ylab('percentage') + ggtitle('Budget')
p2 <- ggplot(aes(x=title_year), data=filtered_df) +
  geom_histogram(aes(y=100*(..count..)/sum(..count..)), color='black', fill='white') + ylab('percentage') + ggtitle('Title Year')
grid.arrange(p1, p2, ncol=2)
```
```{r correlation for numerical}
# features <- names(filtered_df) %in% c('budget', 'title_year')
numeric_columns <- names(filtered_df)[sapply(filtered_df, is.numeric)]
numeric_columns <- setdiff(numeric_columns, "gross")
numeric_vars <- filtered_df[, numeric_columns]
print(names(numeric_vars))

correlation_matrix <- cor(numeric_vars)
print(correlation_matrix)
```

```{r}
# Convert to numeric if it's not already
# cleaned_genres_df$gross_equal_width_bins <- as.numeric(cleaned_genres_df$gross_equal_width_bins)
# 
# hist(cleaned_genres_df$gross_equal_width_bins),
#      main = "Frequency of Gross Revenue Bins",
#      xlab = "Bins",
#      ylab = "Frequency")

custom_breaks <- c(0, 1500000, 30000000, 60000000, 90000000, Inf)
bin_labels <- c("Very Low", "Low", "Medium", "High", "Very High")

cleaned_genres_df$gross_equal_width_bins <- cut(cleaned_genres_df$gross, breaks = custom_breaks, labels = bin_labels, include.lowest = TRUE, right = FALSE)

bin_freq <- table(cleaned_genres_df$gross_equal_width_bins)

barplot(bin_freq, 
     main = "Frequency of Gross Revenue Bins",
     xlab = "Bins",
     ylab = "Frequency")
```

```{r correlation for categorical}

# boxplot(gross ~ genres, data = filtered_df, main = 'Gross Review vs. Genre', xlab = 'Genre', ylab = 'Gross Revenue')
# p1 <- ggplot(aes(x=genre_1), data=cleaned_genres_df) + geom_bar(aes(y=100*(..count..)/sum(..count..))) + ylab('percentage') +
#   ggtitle('Genres') + coord_flip()
# grid.arrange(p1, ncol = 2)
# 

# GGplot for Genres 

# Step 1: Reshape the dataset
cleaned_genres_df <- cleaned_genres_df %>%
  mutate(genres = paste(genre_1, genre_2, genre_3, sep = "|")) %>%
  separate_rows(genres, sep = "\\|") %>%
  filter(!is.na(genres))  # Remove NA values if any

# Step 2: Create a bar plot for genres
p1 <- ggplot(aes(x = genres), data = cleaned_genres_df) +
  geom_bar(aes(y = 100 * (..count..) / sum(..count..)), fill = "skyblue", color = "black") +
  ylab('Percentage') +
  ggtitle('Genres') +
  coord_flip()

# Step 3: Arrange the plot
grid.arrange(p1, ncol = 2)

# Create boxplot for genres
boxplot(cleaned_genres_df$gross_equal_width_bins ~ genres, data = cleaned_genres_df,
        main = 'Gross Revenue vs. Genre', 
        xlab = 'Genre', 
        ylab = 'Gross Revenue',
        las = 2,   # Rotate x-axis labels to be vertical
        cex.axis = 0.8, # Reduce the font size of axis labels
        par(mar = c(10, 5, 4, 2) + 0.1)) # Increase the bottom margin

# GGplot for Actor 1 

# Step 2: Create a bar plot for genres
p1 <- ggplot(aes(x = actor_1_name), data = cleaned_genres_df) +
  geom_bar(aes(y = 100 * (..count..) / sum(..count..)), fill = "skyblue", color = "black") +
  ylab('Percentage') +
  ggtitle('Genres') +
  coord_flip()

# Step 3: Arrange the plot
grid.arrange(p1, ncol = 2)

# Create boxplot for actor 1
top_actors <- head(sort(table(cleaned_genres_df$actor_1_name), decreasing = TRUE), 20)
cleaned_genres_df_subset <- subset(cleaned_genres_df, actor_1_name %in% names(top_actors))

boxplot(cleaned_genres_df$gross_equal_width_bins ~ actor_1_name, data = cleaned_genres_df,
        main = 'Gross Revenue vs. Actor 1', 
        xlab = 'Actor 1', 
        ylab = 'Gross Revenue',
        las = 2,   # Rotate x-axis labels to be vertical
        cex.axis = 0.8, # Reduce the font size of axis labels
        boxwex = 0.8,
        par(mar = c(10, 5, 4, 2) + 0.1)) # Increase the bottom margin

# Create boxplot for actor 2
boxplot(cleaned_genres_df$gross_equal_width_bins ~ actor_2_name, data = cleaned_genres_df,
        main = 'Gross Revenue vs. Actor 2', 
        xlab = 'Actor 2', 
        ylab = 'Gross Revenue',
        las = 2,   # Rotate x-axis labels to be vertical
        cex.axis = 0.8, # Reduce the font size of axis labels
        boxwex = 0.8,
        par(mar = c(10, 5, 4, 2) + 0.1)) # Increase the bottom margin

# Create boxplot for actor 3
boxplot(cleaned_genres_df$gross_equal_width_bins ~ actor_3_name, data = cleaned_genres_df,
        main = 'Gross Revenue vs. Actor 3', 
        xlab = 'Actor 3', 
        ylab = 'Gross Revenue',
        las = 2,   # Rotate x-axis labels to be vertical
        cex.axis = 0.8, # Reduce the font size of axis labels
        boxwex = 0.8,
        par(mar = c(10, 5, 4, 2) + 0.1)) # Increase the bottom margin

# # Summarize by director_name
# summary_by_director <- aggregate(gross ~ director_name, data = filtered_df, FUN = summary)
# print(summary_by_director)

# boxplot(gross ~ director_name, data = cleaned_genres_df,
#         main = 'Gross Revenue vs. Genre', xlab = 'Director', ylab = 'Director Name')


```


## Splitting dataset into train and test
```{r}
# set.seed(2017)
# split <- sample(seq_len(nrow(final_movieset)), size = floor(0.7 * nrow(final_movieset)))
# train <- final_movieset[split, ]
# test <- final_movieset[-split, ]
# dim(train)
# dim(test)
```

## Determining the order of predictors 
```{r}
full_model <- lm(gross~genre+year+score+votes+budget+runtime, data=train)
summary(full_model)
```
## Creating a model 
```{r}
fit1 <- lm(gross ~ votes, data=train)
summary(fit1)
```

```{r}
fit_model <- lm(gross~genre+year+score+budget+runtime, data=train)
print(fit_model)
```

```{r}
fit2 <- lm(gross ~ votes + budget, data=train)
summary(fit2)
```

```{r}
fit_model_2 <- lm(gross~genre+year+score+runtime, data=train)
print(fit_model_2)
```

```{r}
fit3 <- lm(gross ~ votes + budget + genre, data=train)
summary(fit3)
```

```{r}
fit_model_3 <- lm(gross~year+score+runtime, data=train)
print(fit_model_3)
```

```{r}
fit4 <- lm(gross ~ votes + budget + genre, data=train)
summary(fit4)
```

```{r}
fit5 <- lm(gross ~ votes + budget + genre + score, data=train)
summary(fit5)
```

```{r}
fit6 <- lm(gross ~ votes + budget + genre + score + runtime, data=train)
summary(fit6)
```

## Predicting the Model
```{r}
# print(test)
# colnames(test)
# new_movie <- test %>% filter(name == "Xanadu") %>% select(votes, budget, genre, rating, score, runtime)
new_movie <- test %>% select(votes, budget, genre, score, runtime)
# print(new_movie)

# any(is.na(new_movie))

# new_movie$rating <- factor(new_movie$rating, levels = levels(train$rating))
# new_movie$genre <- factor(new_movie$genre, levels = levels(train$genre))

# Make predictions
# predict(fit6, new_movie)

```
```{r}
predict(fit6, new_movie, interval = "prediction", level = 0.05)
```
