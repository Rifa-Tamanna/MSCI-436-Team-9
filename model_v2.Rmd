---
title: "model_v2"
author: "Stuti Munshi"
date: "07/07/2024"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages
```{r cars}
library(dplyr)   
library(readr)  
library(ggplot2)
#library(statsr)
library(gridExtra)
library(corrplot)
library(tidyr)
library(caret)

```

## Dataset 
```{r dataset}
movieset <- read.csv("output.csv")
print(movieset)
```


## Binning Gross Revenue
```{r}
custom_breaks <- c(0, 10000000, 30000000, 90000000, 150000000, Inf)
bin_labels <- c("Very Low", "Low", "Medium", "High", "Very High")

movieset$gross_equal_width_bins <- cut(movieset$gross, breaks = custom_breaks, labels = bin_labels, include.lowest = TRUE, right = FALSE)

bin_freq <- table(movieset$gross_equal_width_bins)

barplot(bin_freq, 
     main = "Frequency of Gross Revenue Bins",
     xlab = "Bins",
     ylab = "Frequency")

```

# Visualization of Numerical Variables 
```{r numerical plots}

p1 <- ggplot(aes(x=year), data=movieset) + 
  geom_histogram(aes(y=100*(..count..)/sum(..count..)), color='black', fill='white') + ylab('percentage') + ggtitle('year')
p2 <- ggplot(aes(x=score), data=movieset) +
  geom_histogram(aes(y=100*(..count..)/sum(..count..)), color='black', fill='white') + ylab('percentage') + ggtitle('score')
p3 <- ggplot(aes(x=log10(votes)), data=movieset) +
  geom_histogram(aes(y=100*(..count..)/sum(..count..)), color='black', fill='white') + ylab('percentage') + ggtitle('votes')
p4 <- ggplot(aes(x=log10(budget)), data=movieset) +
  geom_histogram(aes(y=100*(..count..)/sum(..count..)), color='black', fill='white') + ylab('percentage') + ggtitle('budget')
p5 <- ggplot(aes(x=runtime), data=movieset) +
  geom_histogram(aes(y=100*(..count..)/sum(..count..)), color='black', fill='white') + ylab('percentage') + ggtitle('runtime')
grid.arrange(p1, p2, p3, p4, p5, ncol=2)

```
For the analysis, we will be using year, score, log(votes), log(budget) and runtime. They all have reasonably broad distributions which make them appropriate candidates.

## Correlation Matrix Between Numerical Variables
```{r numerical correlation matrix}
hist(movieset$gross, breaks = 30)
summary(movieset$gross)

# Defining a data frame with all numerical variables from dataset 
numeric_columns <- names(movieset)[sapply(movieset, is.numeric)]
numeric_columns <- setdiff(numeric_columns, "gross")
numeric_vars <- movieset[, numeric_columns]
print(names(numeric_vars))

# Performing correlation test
correlation_matrix <- cor(numeric_vars)

# Visualizing the correlation matrix
corrplot(correlation_matrix, method = "color", type = "upper", 
         order = "hclust", tl.col = "black", tl.srt = 45, 
         addCoef.col = "black", number.cex = 0.7, 
         col = colorRampPalette(c("red", "white", "blue"))(200))
```

As the correlation between all of the numerical variables are relatively low, they can all be used for the prediction analysis. 

## Visualization of Categorical Variables
```{r categorical plots}

#Plotting genre against gross frequency
p1 <- ggplot(aes(x = genre), data = movieset) +
  geom_bar(aes(y = 100 * (..count..) / sum(..count..)), fill = "skyblue", color = "black") +
  ylab('Percentage') +
  ggtitle('Genres') +
  coord_flip()
grid.arrange(p1, ncol = 2)

# Creating boxplot for genre vs gross revenue
boxplot(movieset$gross_equal_width_bins ~ genre, data = movieset,
        main = 'Gross Revenue vs. Genre', 
        xlab = 'Genre', 
        ylab = 'Gross Revenue',
        las = 2,   # Rotate x-axis labels to be vertical
        cex.axis = 0.8, # Reduce the font size of axis labels
        par(mar = c(10, 5, 4, 2) + 0.1)) # Increase the bottom margin


#Plotting rating against gross frequency
p2 <- ggplot(aes(x = rating), data = movieset) +
  geom_bar(aes(y = 100 * (..count..) / sum(..count..)), fill = "skyblue", color = "black") +
  ylab('Percentage') +
  ggtitle('Rating') +
  coord_flip()
grid.arrange(p2, ncol = 2)

# Creating boxplot for rating vs gross revenue
boxplot(movieset$gross_equal_width_bins ~ rating, data = movieset,
        main = 'Gross Revenue vs. Rating', 
        xlab = 'Rating', 
        ylab = 'Gross Revenue',
        las = 2,   # Rotate x-axis labels to be vertical
        cex.axis = 0.8, # Reduce the font size of axis labels
        par(mar = c(10, 5, 4, 2) + 0.1)) # Increase the bottom margin


#Plotting country against gross frequency
p3 <- ggplot(aes(x = country), data = movieset) +
  geom_bar(aes(y = 100 * (..count..) / sum(..count..)), fill = "skyblue", color = "black") +
  ylab('Percentage') +
  ggtitle('Country') +
  coord_flip()
grid.arrange(p3, ncol = 2)

# Creating boxplot for country vs gross revenue
boxplot(movieset$gross_equal_width_bins ~ country, data = movieset,
        main = 'Gross Revenue vs. Country', 
        xlab = 'Country', 
        ylab = 'Gross Revenue',
        las = 2,   # Rotate x-axis labels to be vertical
        cex.axis = 0.8, # Reduce the font size of axis labels
        par(mar = c(10, 5, 4, 2) + 0.1)) # Increase the bottom margin


#Plotting company against gross frequency
p4 <- ggplot(aes(x = company), data = movieset) +
  geom_bar(aes(y = 100 * (..count..) / sum(..count..)), fill = "skyblue", color = "black") +
  ylab('Percentage') +
  ggtitle('Company') +
  coord_flip()
grid.arrange(p4, ncol = 2)


#Plotting director against gross frequency
p5 <- ggplot(aes(x = director), data = movieset) +
  geom_bar(aes(y = 100 * (..count..) / sum(..count..)), fill = "skyblue", color = "black") +
  ylab('Percentage') +
  ggtitle('Director') +
  coord_flip()
grid.arrange(p5, ncol = 2)


#Plotting writer against gross frequency
p6 <- ggplot(aes(x = writer), data = movieset) +
  geom_bar(aes(y = 100 * (..count..) / sum(..count..)), fill = "skyblue", color = "black") +
  ylab('Percentage') +
  ggtitle('Writer') +
  coord_flip()
grid.arrange(p6, ncol = 2)


#Plotting star against gross frequency
p7 <- ggplot(aes(x = star), data = movieset) +
  geom_bar(aes(y = 100 * (..count..) / sum(..count..)), fill = "skyblue", color = "black") +
  ylab('Percentage') +
  ggtitle('Star') +
  coord_flip()
grid.arrange(p7, ncol = 2)
```
After plotting all categorical variables against gross frequency, we see that variables "star", "director" and "company" have too much variety which will make it difficult to train the model using these data points. So, we will remove these features from our dataset.

## Define columns that will be used in the model
```{r}
str(movieset)
movieset_clean <- na.omit(movieset)

final_movieset <- movieset_clean %>% select(name, genre, rating, budget, gross, runtime)
final_movieset <- subset(final_movieset, genre != "Western")
final_movieset <- subset(final_movieset, genre != "Family")
final_movieset <- subset(final_movieset, genre != "Thriller")
final_movieset <- subset(final_movieset, genre != "Sci-Fi")
final_movieset <- subset(final_movieset, genre != "Romance")
final_movieset <- subset(final_movieset, genre != "Mystery")
final_movieset <- subset(final_movieset, rating != "X")
final_movieset <- subset(final_movieset, rating != "Unrated")
final_movieset <- subset(final_movieset, rating != "TV-MA")
final_movieset <- subset(final_movieset, rating != "NC-17")
final_movieset <- subset(final_movieset, rating != "Approved")
final_movieset <- subset(final_movieset, rating != "Not Rated")
print(final_movieset)
```

We will be using genre, rating, and country as prediction variables because gross revenue has a correlation with those three. Due to the high number of unique entries of company, director, writer, and star, we have decided to exclude these variables from our predictive model.

## Determining Feature Importance
```{r feature importance}

library(randomForest)

# Transforming categorical variables into a matrix that can be used to determine feature importance 
x <- final_movieset %>% select(-gross)
x <- data.frame(model.matrix(~genre + rating - 1, data = x))

x$budget <- final_movieset$budget
x$runtime <- final_movieset$runtime
y <- final_movieset$gross

# Training random forest model
set.seed(42)
rf_model_importance <- randomForest(x, y, ntree = 100, importance = TRUE)

# Feature importance based on trained model
importance <- importance(rf_model_importance)
importance_df <- data.frame(Feature = rownames(importance), Importance = importance[, 1])
importance_df <- importance_df %>% arrange(desc(Importance))
print(importance_df)

# Plotting feature importance
ggplot(importance_df, aes(x = reorder(Feature, Importance), y = Importance)) +
  geom_bar(stat = "identity") + coord_flip() + ggtitle("Feature Importance")

```

## Implementing Random Forest Algorithm
```{r}
library(randomForest)

library(caret)

# Defining data set to use for training the model 
last_movie <- final_movieset %>% select(name, genre, budget, gross, rating, runtime)

# Perform one-hot encoding on the categorical variables 
dummies <- dummyVars(~ genre + rating, data = last_movie)
x <- data.frame(predict(dummies, newdata = last_movie))

x$budget <- last_movie$budget
x$runtime <- last_movie$runtime
y <- last_movie$gross

print(last_movie)

# Splitting the dataset into a training and testing set
set.seed(42)
train_indices <- sample(1:nrow(last_movie), 0.8 * nrow(last_movie))
X_train <- x[train_indices, ]
y_train <- y[train_indices]
X_test <- x[-train_indices, ]
y_test <- y[-train_indices]

print(X_train)
print(y_train)

# Train the Random Forest model
rf_model <- randomForest(x = X_train, y = y_train, ntree = 100, mtry = 3, importance = TRUE)
saveRDS(rf_model, file = "rf_model.rds")

# Predict on the test set
y_pred <- predict(rf_model, newdata = X_test)

print(X_test)
```

# Binning Predictions Based on Trained Model
```{r binning predictions}

# Defining the bins and labels
bins <- c(0, 7500000, 25000000, 50000000, 150000000, Inf)
labels <- c("Very low", "Low", "Medium", "High", "Very high")

normal_binned <- cut(last_movie$gross, breaks = bins, labels = labels, right = FALSE)

# Binning the predictions
y_pred_binned <- cut(y_pred, breaks = bins, labels = labels, right = FALSE)

# Printing the binned predictions
print(y_pred_binned)

# To compare with actual values
# y_test_binned <- cut(y_test, breaks = bins, labels = labels, right = FALSE)
# print(y_test_binned)
```
## Calculating the average gross revenue for each genre in the dataset
# Note: Do we plan on displaying this avg value, otherwise we can remove this block of code
```{r}
avg_gross <- last_movie %>%
  group_by(genre) %>%
  summarise(avg_gross = mean(gross, na.rm = TRUE))

# Print or view avg_gross to see the averages calculated
print(avg_gross)
```

## Plotting A Histogram For Genre vs Gross Revenue
```{r}
# Defining bins and labels
bins <- c(0, 7500000, 25000000, 50000000, 150000000, Inf)
labels <- c("Very low", "Low", "Medium", "High", "Very high")

final_movieset <- final_movieset %>%
  mutate(normal_binned = cut(gross, breaks = bins, labels = labels, right = FALSE))

plot_genre <- function(genre, predicted_bin, data = final_movieset) {
  genre_data <- data %>% 
    filter(genre == !!genre) %>%
    mutate(normal_binned = factor(normal_binned, levels = c("Very low", "Low", "Medium", "High", "Very high")))
  
  bin_colors <- setNames(rep("grey", 5), c("Very low", "Low", "Medium", "High", "Very high"))
  bin_colors[predicted_bin] <- "blue"
  
  # Create the plot
  ggplot(genre_data, aes(x = normal_binned, fill = normal_binned)) +
    geom_bar() +
    scale_fill_manual(values = bin_colors) +
    labs(title = paste("Histogram of", genre, "Movies"),
         x = "Gross Revenue",
         y = "Count of Movies") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    guides(fill = "none")
}
saveRDS(plot_genre, "plot_genre.rds")

# Testing the function
plot_genre("Horror", "High")

```

# Create a Scatter Plot of Budget vs. Gross Revenue
```{r}
plot_budget <- function(genre, input_budget, predicted_value, data = final_moviese){
  genre_data <- final_movieset %>% 
      filter(genre == !!genre) %>%
      mutate(normal_binned = factor(normal_binned, levels = c("Very low", "Low", "Medium", "High", "Very high")))
  
  ggplot(genre_data, aes(x = genre_data$budget, y = genre_data$gross)) +
    geom_point(alpha = 0.5) +
    geom_point(data = data.frame(budget = input_budget, gross = predicted_value), 
               aes(x = budget, y = gross), color = "red", size = 5) +
    scale_x_log10(labels = scales::dollar_format()) +
    scale_y_log10(labels = scales::dollar_format()) +
    labs(x = "Budget (log scale)", 
         y = "Gross Revenue (log scale)", 
         title = "Budget vs. Gross Revenue") +
    theme_minimal() +
    annotate("text", x = input_budget, y = predicted_value, fontface = "bold",
             label = "Your Movie", vjust = -1, color = "red") + 
    annotate("text", x = min(genre_data$budget), y = max(genre_data$gross), hjust = 0,
             label = "This graph shows the relationship between budget and gross revenue for movies in the selected genre. 
             The red point represents your movie's budget and its predicted gross revenue.", size = 3, color = "black")  # Add description
  
}

saveRDS(plot_budget, "plot_budget.RDS")

# Testing the function
plot_budget("Drama",500000,416018442)

```
## Plotting A Histogram For Rating vs Gross Revenue
```{r}

# Defining bins and labels
bins <- c(0, 7500000, 25000000, 50000000, 150000000, Inf)
labels <- c("Very low", "Low", "Medium", "High", "Very high")

# Prepare the dataset
final_movieset <- final_movieset %>%
  mutate(normal_binned = cut(gross, breaks = bins, labels = labels, right = FALSE))

plot_rating <- function(rating, predicted_bin, data = final_movieset) {
  # Filter the data for the specific genre
  rating_data <- data %>% 
    filter(rating == !!rating) %>%
    # Ensure normal_binned is a factor with all levels
    mutate(normal_binned = factor(normal_binned, levels = c("Very low", "Low", "Medium", "High", "Very high")))

  # Create color vector
  bin_colors <- setNames(rep("grey", 5), c("Very low", "Low", "Medium", "High", "Very high"))
  bin_colors[predicted_bin] <- "red"


  # Create the plot
  ggplot(rating_data, aes(x = normal_binned, fill = normal_binned)) +
    geom_bar() +
    scale_fill_manual(values = bin_colors) +
    labs(title = paste("Histogram of", rating, "Movies"),
         x = "Gross Revenue",
         y = "Count of Movies") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    guides(fill = "none")
}
saveRDS(plot_rating, "plot_rating.rds")

# Testing the function
plot_rating("R", "High")

```
